{"version":3,"file":"session-prompt.js","sourceRoot":"","sources":["../../../src/public/node/session-prompt.ts"],"names":[],"mappings":"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","sourcesContent":["import {renderSelectPrompt} from './ui.js'\nimport {ensureAuthenticatedUser} from './session.js'\nimport {identityFqdn} from './context/fqdn.js'\nimport * as sessionStore from '../../private/node/session/store.js'\nimport {setCurrentSessionId} from '../../private/node/conf-store.js'\nimport type {Sessions} from '../../private/node/session/schema.js'\n\nconst NEW_LOGIN_VALUE = 'NEW_LOGIN'\n\ninterface SessionChoice {\n  label: string\n  value: string\n}\n\n/**\n * Builds the choices array from existing sessions.\n *\n * @param sessions - The sessions object from storage.\n * @param fqdn - The identity provider FQDN.\n * @returns Array of session choices.\n */\nfunction buildSessionChoices(sessions: Sessions, fqdn: string): SessionChoice[] {\n  const choices: SessionChoice[] = []\n  const fqdnSessions = sessions[fqdn]\n\n  if (fqdnSessions) {\n    for (const [userId, session] of Object.entries(fqdnSessions)) {\n      choices.push({\n        label: session.identity.alias ?? userId,\n        value: userId,\n      })\n    }\n  }\n\n  return choices\n}\n\n/**\n * Handles the new login flow.\n *\n * @returns The alias of the authenticated user.\n */\nasync function handleNewLogin(): Promise<string> {\n  const result = await ensureAuthenticatedUser({}, {forceNewSession: true})\n  const alias = await sessionStore.getSessionAlias(result.userId)\n  return alias ?? result.userId\n}\n\n/**\n * Gets all available session choices including the \"new login\" option.\n *\n * @returns Array of session choices.\n */\nasync function getAllChoices(): Promise<SessionChoice[]> {\n  const sessions = await sessionStore.fetch()\n  const fqdn = await identityFqdn()\n  const choices: SessionChoice[] = []\n\n  if (sessions) {\n    choices.push(...buildSessionChoices(sessions, fqdn))\n  }\n\n  if (choices.length > 0) {\n    choices.push({\n      label: 'Log in with a different account',\n      value: NEW_LOGIN_VALUE,\n    })\n  }\n\n  return choices\n}\n\n/**\n * Prompts the user to select from existing sessions or log in with a different account.\n *\n * - If alias is provided, tries to switch to that session directly\n * - Otherwise, shows a prompt with all available sessions and the option to log in with a different account.\n *\n * @param alias - Optional alias of the account to switch to.\n * @returns Promise with the alias of the chosen session.\n */\nexport async function promptSessionSelect(alias?: string): Promise<string> {\n  if (alias) {\n    const userId = await sessionStore.findSessionByAlias(alias)\n    if (userId) {\n      setCurrentSessionId(userId)\n      return alias\n    }\n  }\n\n  const choices = await getAllChoices()\n  let selectedValue = NEW_LOGIN_VALUE\n\n  if (choices.length > 0) {\n    const message = 'Which account would you like to use?'\n    selectedValue = await renderSelectPrompt({message, choices})\n  }\n\n  if (selectedValue === NEW_LOGIN_VALUE) {\n    return handleNewLogin()\n  }\n\n  setCurrentSessionId(selectedValue)\n  return choices.find((choice) => choice.value === selectedValue)?.label ?? selectedValue\n}\n"]}
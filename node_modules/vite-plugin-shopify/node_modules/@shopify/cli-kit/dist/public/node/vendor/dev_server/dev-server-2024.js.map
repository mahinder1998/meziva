{"version":3,"file":"dev-server-2024.js","sourceRoot":"","sources":["../../../../../src/public/node/vendor/dev_server/dev-server-2024.ts"],"names":[],"mappings":"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","sourcesContent":["import fs from 'node:fs'\n\nimport * as ni from 'network-interfaces'\n\nimport type {HostOptions} from './types.js'\nimport {assertConnectable, getIpFromHosts} from './network/index.js'\nimport {assertCompatibleEnvironment} from './env.js'\n\nconst NON_SHOP_PREFIXES = ['app', 'dev', 'shopify']\nconst BACKEND_PORT = 8080\n\nexport function createServer(projectName: string) {\n  return {\n    host: (options: HostOptions = {}) => host(projectName, options),\n    url: (options: HostOptions = {}) => url(projectName, options),\n  }\n}\n\nfunction host(projectName: string, options: HostOptions = {}): string {\n  assertCompatibleEnvironment()\n  ;(assertRunningOverride || assertRunning2024)(projectName)\n\n  const prefix = (options.nonstandardHostPrefix || projectName).replace(/_/g, '-')\n\n  if (projectName === 'shopify') {\n    if (prefix.endsWith('-dev-api')) {\n      const shopName = prefix.replace('-dev-api', '')\n      return `${shopName}.dev-api.shop.dev`\n    }\n    if (!NON_SHOP_PREFIXES.includes(prefix)) {\n      return `${prefix}.my.shop.dev`\n    }\n  }\n  return `${prefix}.shop.dev`\n}\n\nfunction url(projectName: string, options: HostOptions = {}): string {\n  return `https://${host(projectName, options)}`\n}\n\nfunction assertRunning2024(projectName: string): void {\n  assertConnectable({\n    projectName,\n    addr: getBackendIp(projectName),\n    port: BACKEND_PORT,\n  })\n}\n\nfunction getBackendIp(projectName: string): string {\n  try {\n    const backendIp = resolveBackendHost(projectName)\n    ni.fromIp(backendIp, {internal: true, ipVersion: 4})\n\n    return backendIp\n  } catch (error) {\n    throw new Error(`DevServer for '${projectName}' is not running: \\`dev up ${projectName}\\` to start it.`)\n  }\n}\n\nfunction resolveBackendHost(name: string): string {\n  let host: string\n  try {\n    host = fs.readlinkSync(`/opt/nginx/etc/manifest/${name}/current`)\n  } catch (error) {\n    host = `${name}.root.shopify.dev.internal`\n  }\n\n  try {\n    return getIpFromHosts(host)\n  } catch {\n    return host\n  }\n}\n\n// Allow overrides for more concise test setup. Meh.\nlet assertRunningOverride: typeof assertRunning2024 | undefined\n\nexport function setAssertRunning(override: typeof assertRunningOverride) {\n  assertRunningOverride = override\n}\n"]}
{"version":3,"file":"functions.js","sourceRoot":"","sources":["../../../../src/public/node/api/functions.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,iBAAiB,EAAsB,MAAM,cAAc,CAAA;AACnE,OAAO,EAAC,kBAAkB,EAAC,MAAM,qBAAqB,CAAA;AACtD,OAAO,EAAC,iBAAiB,EAAC,MAAM,oBAAoB,CAAA;AAGpD,OAAO,UAAU,MAAM,YAAY,CAAA;AAEnC,sEAAsE;AACtE,yEAAyE;AACzE,iDAAiD;AACjD,MAAM,OAAO,GAAG,IAAI,UAAU,CAAC;IAC7B,OAAO,EAAE,GAAG;IACZ,aAAa,EAAE,EAAE;CAClB,CAAC,CAAA;AAEF;;;;;;;GAOG;AACH,KAAK,UAAU,YAAY,CAAC,KAAa,EAAE,KAAa,EAAE,KAAa;IACrE,MAAM,GAAG,GAAG,WAAW,CAAA;IACvB,MAAM,IAAI,GAAG,MAAM,iBAAiB,EAAE,CAAA;IACtC,MAAM,GAAG,GAAG,WAAW,IAAI,qCAAqC,KAAK,IAAI,KAAK,UAAU,CAAA;IAExF,OAAO;QACL,KAAK;QACL,GAAG;QACH,GAAG;QACH,eAAe,EAAE,EAAC,UAAU,EAAE,kBAAkB,EAAC;KAClD,CAAA;AACH,CAAC;AAmBD;;;;;GAKG;AACH,MAAM,CAAC,KAAK,UAAU,mBAAmB,CACvC,OAAqD;IAErD,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,QAAQ,CAAU,KAAK,IAAI,EAAE;QACxD,OAAO,iBAAiB,CAAsB;YAC5C,GAAG,CAAC,MAAM,YAAY,CAAC,OAAO,CAAC,cAAc,EAAE,OAAO,CAAC,KAAK,EAAE,OAAO,CAAC,KAAK,CAAC,CAAC;YAC7E,KAAK,EAAE,OAAO,CAAC,KAAK;YACpB,SAAS,EAAE,OAAO,CAAC,SAAS;YAC5B,mBAAmB,EAAE,OAAO,CAAC,mBAAmB;SACjD,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;IAEF,OAAO,MAAM,CAAA;AACf,CAAC","sourcesContent":["import {graphqlRequestDoc, UnauthorizedHandler} from './graphql.js'\nimport {handleDeprecations} from './app-management.js'\nimport {appManagementFqdn} from '../context/fqdn.js'\nimport {TypedDocumentNode} from '@graphql-typed-document-node/core'\nimport {Variables} from 'graphql-request'\nimport Bottleneck from 'bottleneck'\n\n// API Rate limiter for partners API (Limit is 10 requests per second)\n// Jobs are launched every 150ms to add an extra 50ms margin per request.\n// Only 10 requests can be executed concurrently.\nconst limiter = new Bottleneck({\n  minTime: 150,\n  maxConcurrent: 10,\n})\n\n/**\n * Prepares the request configuration for the App Management Functions API.\n *\n * @param orgId - Organization identifier.\n * @param token - Authentication token.\n * @param appId - App identifier.\n * @returns Request configuration object.\n */\nasync function setupRequest(orgId: string, token: string, appId: string) {\n  const api = 'Functions'\n  const fqdn = await appManagementFqdn()\n  const url = `https://${fqdn}/functions/unstable/organizations/${orgId}/${appId}/graphql`\n\n  return {\n    token,\n    api,\n    url,\n    responseOptions: {onResponse: handleDeprecations},\n  }\n}\n\n/**\n * @param orgId - Organization identifier.\n * @param query - Typed GraphQL document node.\n * @param token - Authentication token.\n * @param appId - App identifier.\n * @param variables - Optional query variables.\n * @param unauthorizedHandler - Optional handler for unauthorized requests.\n */\nexport interface FunctionsRequestOptions<TResult, TVariables extends Variables> {\n  organizationId: string\n  query: TypedDocumentNode<TResult, TVariables>\n  token: string\n  appId: string\n  unauthorizedHandler: UnauthorizedHandler\n  variables?: TVariables\n}\n\n/**\n * Executes a rate-limited GraphQL request against the App Management Functions API.\n *\n * @param options - Request options.\n * @returns Promise resolving to the typed query result.\n */\nexport async function functionsRequestDoc<TResult, TVariables extends Variables>(\n  options: FunctionsRequestOptions<TResult, TVariables>,\n): Promise<TResult> {\n  const result = await limiter.schedule<TResult>(async () => {\n    return graphqlRequestDoc<TResult, TVariables>({\n      ...(await setupRequest(options.organizationId, options.token, options.appId)),\n      query: options.query,\n      variables: options.variables,\n      unauthorizedHandler: options.unauthorizedHandler,\n    })\n  })\n\n  return result\n}\n"]}
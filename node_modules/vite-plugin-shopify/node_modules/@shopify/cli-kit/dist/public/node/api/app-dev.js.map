{"version":3,"file":"app-dev.js","sourceRoot":"","sources":["../../../../src/public/node/api/app-dev.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,iBAAiB,EAAsB,MAAM,cAAc,CAAA;AAEnE,OAAO,EAAC,UAAU,EAAE,kBAAkB,EAAC,MAAM,oBAAoB,CAAA;AACjE,OAAO,EAAC,kBAAkB,EAAC,MAAM,0CAA0C,CAAA;AAC3E,OAAO,UAAU,MAAM,YAAY,CAAA;AAInC,mBAAmB;AACnB,gCAAgC;AAChC,iDAAiD;AACjD,MAAM,OAAO,GAAG,IAAI,UAAU,CAAC;IAC7B,OAAO,EAAE,GAAG;IACZ,aAAa,EAAE,EAAE;CAClB,CAAC,CAAA;AAiBF;;;;;;GAMG;AACH,MAAM,CAAC,KAAK,UAAU,gBAAgB,CACpC,OAAkD;IAElD,MAAM,GAAG,GAAG,SAAS,CAAA;IACrB,MAAM,kBAAkB,GAAG,kBAAkB,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAA;IAC/D,MAAM,IAAI,GAAG,MAAM,UAAU,CAAC,kBAAkB,CAAC,CAAA;IACjD,MAAM,GAAG,GAAG,WAAW,IAAI,gCAAgC,CAAA;IAE3D,MAAM,YAAY,GAAG,kBAAkB,EAAE,KAAK,OAAO,CAAC,CAAC,CAAC,EAAC,kBAAkB,EAAE,kBAAkB,EAAC,CAAC,CAAC,CAAC,SAAS,CAAA;IAE5G,MAAM,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAU,GAAG,EAAE,CAC5C,iBAAiB,CAAsB;QACrC,KAAK,EAAE,OAAO,CAAC,KAAK;QACpB,GAAG;QACH,GAAG;QACH,KAAK,EAAE,OAAO,CAAC,KAAK;QACpB,YAAY;QACZ,SAAS,EAAE,OAAO,CAAC,SAAS;QAC5B,mBAAmB,EAAE,OAAO,CAAC,mBAAmB;QAChD,kBAAkB,EAAE,OAAO,CAAC,cAAc,EAAE,WAAW;KACxD,CAAC,CACH,CAAA;IAED,OAAO,MAAM,CAAA;AACf,CAAC","sourcesContent":["import {graphqlRequestDoc, UnauthorizedHandler} from './graphql.js'\nimport {RequestOptions} from './app-management.js'\nimport {appDevFqdn, normalizeStoreFqdn} from '../context/fqdn.js'\nimport {serviceEnvironment} from '../../../private/node/context/service.js'\nimport Bottleneck from 'bottleneck'\nimport {Variables} from 'graphql-request'\nimport {TypedDocumentNode} from '@graphql-typed-document-node/core'\n\n// API Rate limiter\n// Jobs are launched every 150ms\n// Only 10 requests can be executed concurrently.\nconst limiter = new Bottleneck({\n  minTime: 150,\n  maxConcurrent: 10,\n})\n\n/**\n * @param query - GraphQL query to execute.\n * @param shopFqdn - The shop fqdn.\n * @param token - Partners token.\n * @param variables - GraphQL variables to pass to the query.\n * @param unauthorizedHandler - Unauthorized handler to use.\n */\nexport interface AppDevRequestOptions<TResult, TVariables extends Variables> {\n  query: TypedDocumentNode<TResult, TVariables>\n  shopFqdn: string\n  token: string\n  unauthorizedHandler: UnauthorizedHandler\n  variables?: TVariables\n  requestOptions?: RequestOptions\n}\n/**\n * Executes an org-scoped GraphQL query against the App Management API.\n * Uses typed documents.\n *\n * @param options - The options for the request.\n * @returns The response of the query of generic type <T>.\n */\nexport async function appDevRequestDoc<TResult, TVariables extends Variables>(\n  options: AppDevRequestOptions<TResult, TVariables>,\n): Promise<TResult> {\n  const api = 'App Dev'\n  const normalizedShopFqdn = normalizeStoreFqdn(options.shopFqdn)\n  const fqdn = await appDevFqdn(normalizedShopFqdn)\n  const url = `https://${fqdn}/app_dev/unstable/graphql.json`\n\n  const addedHeaders = serviceEnvironment() === 'local' ? {'x-forwarded-host': normalizedShopFqdn} : undefined\n\n  const result = limiter.schedule<TResult>(() =>\n    graphqlRequestDoc<TResult, TVariables>({\n      query: options.query,\n      api,\n      url,\n      token: options.token,\n      addedHeaders,\n      variables: options.variables,\n      unauthorizedHandler: options.unauthorizedHandler,\n      preferredBehaviour: options.requestOptions?.requestMode,\n    }),\n  )\n\n  return result\n}\n"]}
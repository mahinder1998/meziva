{"version":3,"file":"storage.js","sourceRoot":"","sources":["../../../../src/private/node/analytics/storage.ts"],"names":[],"mappings":"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","sourcesContent":["import {categorizeError, formatErrorMessage, ErrorCategory} from './error-categorizer.js'\nimport {BArray, BMap} from './bounded-collections.js'\n\ninterface TimingEntry {\n  event: string\n  duration: number\n}\n\ninterface ErrorEntry {\n  category: ErrorCategory\n  message: string\n  timestamp: number\n}\n\ninterface RetryEntry {\n  url: string\n  operation: string\n  attempts: number\n  timestamp: number\n}\n\ninterface EventEntry {\n  name: string\n  timestamp: number\n}\n\nexport interface RuntimeData {\n  timings: TimingEntry[]\n  errors: ErrorEntry[]\n  retries: RetryEntry[]\n  events: EventEntry[]\n}\n\nconst _runtimeAnalyticsStore = {\n  timings: new BArray<TimingEntry>(),\n  activeTimings: new BMap<string, number>(),\n  errors: new BArray<ErrorEntry>(),\n  retries: new BArray<RetryEntry>(),\n  events: new BArray<EventEntry>(),\n}\n\nexport function recordTiming(eventName: string): void {\n  const now = Date.now()\n\n  if (!_runtimeAnalyticsStore.activeTimings.has(eventName)) {\n    _runtimeAnalyticsStore.activeTimings.set(eventName, now)\n    recordEvent(`timing:start:${eventName}`)\n    return\n  }\n\n  const startTime = _runtimeAnalyticsStore.activeTimings.get(eventName)\n  if (startTime === undefined) return\n\n  const duration = now - startTime\n\n  _runtimeAnalyticsStore.timings.push({\n    event: eventName,\n    duration,\n  })\n\n  _runtimeAnalyticsStore.activeTimings.delete(eventName)\n\n  recordEvent(`timing:end:${eventName}`)\n}\n\nexport function recordError(error: unknown): void {\n  const category = categorizeError(error)\n  const errorEntry: ErrorEntry = {\n    category,\n    message: (error instanceof Error ? error.message : String(error)).substring(0, 200),\n    timestamp: Date.now(),\n  }\n\n  if (errorEntry.category === ErrorCategory.Unknown && !errorEntry.message) {\n    return\n  }\n\n  _runtimeAnalyticsStore.errors.push(errorEntry)\n\n  const normalizedErrorCategory = category.toLowerCase()\n  const normalizedErrorMessage = formatErrorMessage(error, category)\n\n  recordEvent(`error:${normalizedErrorCategory}:${normalizedErrorMessage}`)\n}\n\nexport function recordRetry(url: string, operation: string): void {\n  const existingEntries = _runtimeAnalyticsStore.retries.filter(\n    (entry) => entry.url === url && entry.operation === operation,\n  )\n  const attemptCount = existingEntries.length + 1\n\n  _runtimeAnalyticsStore.retries.push({\n    url,\n    operation,\n    attempts: attemptCount,\n    timestamp: Date.now(),\n  })\n\n  recordEvent(`retry:${operation}:attempt:${attemptCount}`)\n}\n\nexport function recordEvent(eventName: string): void {\n  _runtimeAnalyticsStore.events.push({\n    name: eventName,\n    timestamp: Date.now(),\n  })\n}\n\nexport function compileData(): RuntimeData {\n  return {\n    timings: _runtimeAnalyticsStore.timings.toArray(),\n    errors: _runtimeAnalyticsStore.errors.toArray(),\n    retries: _runtimeAnalyticsStore.retries.toArray(),\n    events: _runtimeAnalyticsStore.events.toArray(),\n  }\n}\n\nexport function reset(): void {\n  _runtimeAnalyticsStore.timings.clear()\n  _runtimeAnalyticsStore.activeTimings.clear()\n  _runtimeAnalyticsStore.errors.clear()\n  _runtimeAnalyticsStore.retries.clear()\n  _runtimeAnalyticsStore.events.clear()\n}\n"]}
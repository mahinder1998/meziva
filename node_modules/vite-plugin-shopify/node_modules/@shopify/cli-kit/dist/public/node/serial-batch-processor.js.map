{"version":3,"file":"serial-batch-processor.js","sourceRoot":"","sources":["../../../src/public/node/serial-batch-processor.ts"],"names":[],"mappings":"AAAA;;;;GAIG;AACH,MAAM,OAAO,oBAAoB;IAI/B,YAA6B,YAA2C;QAA3C,iBAAY,GAAZ,YAAY,CAA+B;QAHhE,UAAK,GAAQ,EAAE,CAAA;QACf,sBAAiB,GAA8B,SAAS,CAAA;IAEW,CAAC;IAE5E,OAAO,CAAC,IAAO;QACb,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;QAErB,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAC5B,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC,eAAe,EAAE,CAAA;QACjD,CAAC;IACH,CAAC;IAED,KAAK,CAAC,iBAAiB;QACrB,IAAI,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAC3B,OAAO,IAAI,CAAC,iBAAiB,CAAA;QAC/B,CAAC;IACH,CAAC;IAEO,KAAK,CAAC,eAAe;QAC3B,IAAI,CAAC;YACH,OAAO,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC7B,oCAAoC;gBACpC,MAAM,KAAK,GAAG,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,CAAA;gBAC7B,IAAI,CAAC,KAAK,GAAG,EAAE,CAAA;gBAEf,4BAA4B;gBAC5B,4CAA4C;gBAC5C,MAAM,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,CAAA;YAChC,CAAC;QACH,CAAC;gBAAS,CAAC;YACT,iDAAiD;YACjD,IAAI,CAAC,iBAAiB,GAAG,SAAS,CAAA;QACpC,CAAC;IACH,CAAC;CACF","sourcesContent":["/**\n * Handles serial processing of items with automatic batching\n * Only one processing operation runs at a time, with new items\n * automatically queued for the next batch.\n */\nexport class SerialBatchProcessor<T> {\n  private queue: T[] = []\n  private processingPromise: Promise<void> | undefined = undefined\n\n  constructor(private readonly processBatch: (items: T[]) => Promise<void>) {}\n\n  enqueue(item: T): void {\n    this.queue.push(item)\n\n    if (!this.processingPromise) {\n      this.processingPromise = this.startProcessing()\n    }\n  }\n\n  async waitForCompletion(): Promise<void> {\n    if (this.processingPromise) {\n      return this.processingPromise\n    }\n  }\n\n  private async startProcessing(): Promise<void> {\n    try {\n      while (this.queue.length > 0) {\n        // Get current batch and clear queue\n        const batch = [...this.queue]\n        this.queue = []\n\n        // Process the current batch\n        // eslint-disable-next-line no-await-in-loop\n        await this.processBatch(batch)\n      }\n    } finally {\n      // Always make sure we reset the processing state\n      this.processingPromise = undefined\n    }\n  }\n}\n"]}
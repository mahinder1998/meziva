{"version":3,"file":"error-categorizer.js","sourceRoot":"","sources":["../../../../src/private/node/analytics/error-categorizer.ts"],"names":[],"mappings":"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","sourcesContent":["export enum ErrorCategory {\n  Liquid = 'LIQUID',\n  ThemeCheck = 'THEME_CHECK',\n  Network = 'NETWORK',\n  FileSystem = 'FILE_SYSTEM',\n  Authentication = 'AUTHENTICATION',\n  Validation = 'VALIDATION',\n  Permission = 'PERMISSION',\n  RateLimit = 'RATE_LIMIT',\n  Json = 'JSON',\n  Unknown = 'UNKNOWN',\n}\n\nconst ERROR_CATEGORY_TERMS = {\n  [ErrorCategory.Liquid]: ['liquid'],\n  [ErrorCategory.Json]: ['json', 'parse response'],\n  [ErrorCategory.ThemeCheck]: ['theme check'],\n  [ErrorCategory.Authentication]: ['unauthorized', 'forbidden', 'auth', 'token', 'credential'],\n  [ErrorCategory.Network]: [\n    'eai_again',\n    'econn',\n    'enetunreach',\n    'enotfound',\n    'epipe',\n    'etimedout',\n    'fetch',\n    'network',\n    'request',\n    'socket',\n    'the operation was aborted',\n    'timed out',\n    'timeout',\n  ],\n  [ErrorCategory.FileSystem]: ['enoent', 'eacces', 'file', 'directory', 'path'],\n  [ErrorCategory.Permission]: ['permission', 'denied', 'access', 'insufficient'],\n  [ErrorCategory.RateLimit]: ['rate limit', 'too many requests', 'throttle'],\n  [ErrorCategory.Validation]: ['validation', 'invalid', 'required'],\n}\n\nexport function categorizeError(error: unknown): ErrorCategory {\n  if (!(error instanceof Error)) return ErrorCategory.Unknown\n\n  const message = error.message.toLowerCase()\n\n  for (const [category, terms] of Object.entries(ERROR_CATEGORY_TERMS)) {\n    const hasTerm = terms.some((term) => message.includes(term))\n\n    if (hasTerm) {\n      return category as ErrorCategory\n    }\n  }\n\n  return ErrorCategory.Unknown\n}\n\n/**\n * Formats an error message for analytics tracking, preserving important information\n * based on the error category while keeping it concise and normalized.\n */\nexport function formatErrorMessage(error: unknown, category: ErrorCategory): string {\n  const message = error instanceof Error ? error.message : String(error)\n\n  const formatter = ERROR_FORMATTERS[category] || formatGenericError\n  return formatter(message)\n}\n\nconst ERROR_FORMATTERS: {[key in ErrorCategory]: (message: string) => string} = {\n  [ErrorCategory.Network]: formatNetworkError,\n  [ErrorCategory.Authentication]: formatGenericError,\n  [ErrorCategory.FileSystem]: formatGenericError,\n  [ErrorCategory.RateLimit]: formatGenericError,\n  [ErrorCategory.Json]: formatGenericError,\n  [ErrorCategory.Validation]: formatGenericError,\n  [ErrorCategory.Permission]: formatGenericError,\n  [ErrorCategory.Liquid]: formatGenericError,\n  [ErrorCategory.ThemeCheck]: formatGenericError,\n  [ErrorCategory.Unknown]: formatGenericError,\n}\n\nfunction formatNetworkError(message: string): string {\n  const httpStatusMatch = message.match(/\\b([1-5]\\d{2})\\b/)\n  const connectionErrorMatch = message.match(/\\b(E[A-Z]+)\\b/)\n  const graphqlCodeMatch = message.match(/(?:code|error)[:\\s]*(\\d{3})/i)\n\n  let normalized = message.toLowerCase().substring(0, 50)\n\n  if (httpStatusMatch?.[1]) {\n    const statusCode = httpStatusMatch[1]\n    normalized = `http-${statusCode}-${normalized.replace(/\\b\\d{3}\\b/g, '').trim()}`\n  } else if (graphqlCodeMatch?.[1]) {\n    const statusCode = graphqlCodeMatch[1]\n    normalized = `http-${statusCode}-${normalized.replace(/(?:code|error)[:\\s]*\\d{3}/gi, '').trim()}`\n  } else if (connectionErrorMatch?.[1]) {\n    const errorCode = connectionErrorMatch[1].toLowerCase()\n    normalized = `http-000-${errorCode}-${normalized.replace(/\\b[eE][A-Z]+\\b/g, '').trim()}`\n  } else {\n    normalized = `http-000-${normalized}`\n  }\n\n  return normalized\n    .replace(/[^a-zA-Z0-9-]/g, '-')\n    .replace(/-+/g, '-')\n    .replace(/^-|-$/g, '')\n    .substring(0, 50)\n}\n\nfunction formatGenericError(message: string): string {\n  return message\n    .toLowerCase()\n    .substring(0, 50)\n    .replace(/[^a-zA-Z0-9]/g, '-')\n    .replace(/-+/g, '-')\n    .replace(/^-|-$/g, '')\n}\n"]}
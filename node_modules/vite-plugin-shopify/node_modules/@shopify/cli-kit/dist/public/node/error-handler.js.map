{"version":3,"file":"error-handler.js","sourceRoot":"","sources":["../../../src/public/node/error-handler.ts"],"names":[],"mappings":"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","sourcesContent":["import {CommandExitMode, reportAnalyticsEvent} from './analytics.js'\nimport * as path from './path.js'\nimport {fanoutHooks} from './plugins.js'\nimport * as metadata from './metadata.js'\nimport {\n  AbortSilentError,\n  CancelExecution,\n  errorMapper,\n  shouldReportErrorAsUnexpected,\n  handler,\n  cleanSingleStackTracePath,\n} from './error.js'\nimport {isLocalEnvironment} from '../../private/node/context/service.js'\nimport {getEnvironmentData} from '../../private/node/analytics.js'\nimport {outputDebug, outputInfo} from '../../public/node/output.js'\nimport {bugsnagApiKey, reportingRateLimit} from '../../private/node/constants.js'\nimport {CLI_KIT_VERSION} from '../common/version.js'\nimport {runWithRateLimit} from '../../private/node/conf-store.js'\nimport {getLastSeenUserIdAfterAuth} from '../../private/node/session.js'\nimport {settings, Interfaces} from '@oclif/core'\nimport StackTracey from 'stacktracey'\nimport Bugsnag, {Event} from '@bugsnag/js'\nimport {realpath} from 'fs/promises'\n\n// Allowed slice names for error analytics grouping.\n// Hardcoded list per product slices to keep analytics consistent.\nconst ALLOWED_SLICE_NAMES = new Set<string>(['app', 'theme', 'hydrogen', 'store'])\n\nexport async function errorHandler(\n  error: Error & {exitCode?: number | undefined},\n  config?: Interfaces.Config,\n): Promise<void> {\n  if (error instanceof CancelExecution) {\n    if (error.message && error.message !== '') {\n      outputInfo(`âœ¨  ${error.message}`)\n    }\n  } else if (error instanceof AbortSilentError) {\n    /* empty */\n  } else {\n    return errorMapper(error)\n      .then((error) => {\n        return handler(error)\n      })\n      .then((mappedError) => {\n        return reportError(mappedError, config)\n      })\n  }\n}\n\nconst reportError = async (error: unknown, config?: Interfaces.Config): Promise<void> => {\n  // categorise the error first\n  let exitMode: CommandExitMode = 'expected_error'\n  if (shouldReportErrorAsUnexpected(error)) exitMode = 'unexpected_error'\n\n  if (config !== undefined) {\n    // Log an analytics event when there's an error\n    await reportAnalyticsEvent({config, errorMessage: error instanceof Error ? error.message : undefined, exitMode})\n  }\n  await sendErrorToBugsnag(error, exitMode)\n}\n\n/**\n * Sends an error to Bugsnag. This is configured automatically for uncaught errors from CLI commands, but can also be used to manually record an error.\n *\n * @returns the reported error (this may have been tweaked for better reporting), and a bool to indicate if the error was actually submitted or not\n */\nexport async function sendErrorToBugsnag(\n  error: unknown,\n  exitMode: Omit<CommandExitMode, 'ok'>,\n): Promise<{reported: false; error: unknown; unhandled: unknown} | {error: Error; reported: true; unhandled: boolean}> {\n  try {\n    if (isLocalEnvironment() || settings.debug) {\n      outputDebug(`Skipping Bugsnag report`)\n      return {reported: false, error, unhandled: undefined}\n    }\n\n    // If the error was unexpected, we flag it as \"unhandled\" in Bugsnag. This is a helpful distinction.\n    const unhandled = exitMode === 'unexpected_error'\n\n    let reportableError: Error\n    let stacktrace: string | undefined\n    let report = false\n\n    if (error instanceof Error) {\n      report = true\n      reportableError = new Error(error.message)\n      stacktrace = error.stack\n\n      /**\n       * Some errors that reach this point have an empty string. For example:\n       * https://app.bugsnag.com/shopify/cli/errors/62cd5d31fd5040000814086c?filters[event.since]=30d&filters[error.status]=new&filters[release.seen_in]=3.1.0\n       *\n       * Because at this point we have neither the error message nor a stack trace reporting them\n       * to Bugsnag is pointless and adds noise.\n       */\n    } else if (typeof error === 'string' && error.trim().length !== 0) {\n      report = true\n      reportableError = new Error(error)\n      stacktrace = reportableError.stack\n    } else {\n      report = false\n      reportableError = new Error('Unknown error')\n    }\n\n    const formattedStacktrace = new StackTracey(stacktrace ?? '')\n      .clean()\n      .items.map((item) => {\n        const filePath = cleanSingleStackTracePath(item.file)\n        return `    at ${item.callee} (${filePath}:${item.line}:${item.column})`\n      })\n      .join('\\n')\n    reportableError.stack = `Error: ${reportableError.message}\\n${formattedStacktrace}`\n\n    let withinRateLimit = false\n    await runWithRateLimit({\n      key: 'send-error-to-bugsnag',\n      ...reportingRateLimit,\n      task: async () => {\n        withinRateLimit = true\n      },\n    })\n    if (!withinRateLimit) {\n      outputDebug(`Skipping Bugsnag report due to rate limiting`)\n      report = false\n    }\n\n    if (report) {\n      initializeBugsnag()\n      const userId = await getLastSeenUserIdAfterAuth()\n      await new Promise((resolve, reject) => {\n        outputDebug(`Reporting ${unhandled ? 'unhandled' : 'handled'} error to Bugsnag: ${reportableError.message}`)\n        const eventHandler = (event: Event) => {\n          event.severity = 'error'\n          event.unhandled = unhandled\n          event.setUser(userId)\n          // Attach command metadata so we know which CLI command triggered the error\n          const {commandStartOptions} = metadata.getAllSensitiveMetadata()\n          const {startCommand} = commandStartOptions ?? {}\n          if (startCommand) {\n            const firstWord = startCommand.trim().split(/\\s+/)[0] ?? 'cli'\n            const sliceName = ALLOWED_SLICE_NAMES.has(firstWord) ? firstWord : 'cli'\n            event.addMetadata('custom', {slice_name: sliceName})\n          }\n        }\n        const errorHandler = (error: unknown) => {\n          if (error) {\n            reject(error)\n          } else {\n            resolve(reportableError)\n          }\n        }\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        Bugsnag.notify(reportableError, eventHandler, errorHandler)\n      })\n    }\n    return {error: reportableError, reported: report, unhandled}\n    // eslint-disable-next-line no-catch-all/no-catch-all\n  } catch (err) {\n    outputDebug(`Error reporting to Bugsnag: ${err}`)\n    return {error, reported: false, unhandled: undefined}\n  }\n}\n\n/**\n * If the given file path is within a node_modules folder, remove prefix up\n * to and including the node_modules folder.\n *\n * This gives us very consistent paths for errors generated by the CLI.\n */\nexport function cleanStackFrameFilePath({\n  currentFilePath,\n  projectRoot,\n  pluginLocations,\n}: {\n  currentFilePath: string\n  projectRoot: string\n  pluginLocations: {name: string; pluginPath: string}[]\n}): string {\n  const fullLocation = path.isAbsolutePath(currentFilePath)\n    ? currentFilePath\n    : path.joinPath(projectRoot, currentFilePath)\n\n  const matchingPluginPath = pluginLocations.filter(({pluginPath}) => fullLocation.startsWith(pluginPath))[0]\n\n  if (matchingPluginPath !== undefined) {\n    // the plugin name (e.g. @shopify/cli-kit), plus the relative path of the error line from within the plugin's code (e.g. dist/something.js )\n    return path.joinPath(matchingPluginPath.name, path.relativePath(matchingPluginPath.pluginPath, fullLocation))\n  }\n\n  // strip prefix up to node_modules folder, so we can normalize error reporting\n  return currentFilePath.replace(/.*node_modules\\//, '')\n}\n\n/**\n * Register a Bugsnag error listener to clean up stack traces for errors within plugin code.\n *\n */\nexport async function registerCleanBugsnagErrorsFromWithinPlugins(config: Interfaces.Config): Promise<void> {\n  // Bugsnag have their own plug-ins that use this private field\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const bugsnagConfigProjectRoot: string = (Bugsnag as any)?._client?._config?.projectRoot ?? path.cwd()\n  const projectRoot = path.normalizePath(bugsnagConfigProjectRoot)\n  const pluginLocations = await Promise.all(\n    [...config.plugins].map(async ([_, plugin]) => {\n      const followSymlinks = await realpath(plugin.root)\n      return {name: plugin.name, pluginPath: path.normalizePath(followSymlinks)}\n    }),\n  )\n  initializeBugsnag()\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  Bugsnag.addOnError(async (event) => {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    event.errors.forEach((error: any) => {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      error.stacktrace.forEach((stackFrame: any) => {\n        stackFrame.file = cleanStackFrameFilePath({currentFilePath: stackFrame.file, projectRoot, pluginLocations})\n      })\n    })\n    try {\n      await addBugsnagMetadata(event, config)\n      // eslint-disable-next-line no-catch-all/no-catch-all\n    } catch (metadataError) {\n      outputDebug(`There was an error adding metadata to the Bugsnag report; Ignoring and carrying on ${metadataError}`)\n    }\n  })\n}\n\n// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types, @typescript-eslint/no-explicit-any\nexport async function addBugsnagMetadata(event: any, config: Interfaces.Config): Promise<void> {\n  const publicData = metadata.getAllPublicMetadata()\n  const {commandStartOptions} = metadata.getAllSensitiveMetadata()\n  const {startCommand} = commandStartOptions ?? {}\n\n  const {'@shopify/app': appPublic, ...otherPluginsPublic} = await fanoutHooks(config, 'public_command_metadata', {})\n\n  const environment = await getEnvironmentData(config)\n\n  const allMetadata = {\n    command: startCommand,\n    ...appPublic,\n    ...publicData,\n    ...environment,\n    pluginData: otherPluginsPublic,\n  }\n\n  const appData = {} as {[key: string]: unknown}\n  const commandData = {} as {[key: string]: unknown}\n  const environmentData = {} as {[key: string]: unknown}\n  const miscData = {} as {[key: string]: unknown}\n  const appKeys = ['api_key', 'business_platform_id', 'partner_id', 'project_type']\n  const commandKeys = ['command']\n  const environmentKeys = ['cli_version', 'node_version', 'uname']\n\n  Object.entries(allMetadata).forEach(([key, value]) => {\n    if (key.startsWith('app_') || appKeys.includes(key)) {\n      appData[key] = value\n    } else if (key.startsWith('cmd_') || commandKeys.includes(key)) {\n      commandData[key] = value\n    } else if (key.startsWith('env_') || environmentKeys) {\n      environmentData[key] = value\n    } else {\n      miscData[key] = value\n    }\n  })\n\n  // app, command, environment, misc\n  const bugsnagMetadata = {\n    'Shopify App': appData,\n    Command: commandData,\n    Environment: environmentData,\n    Misc: miscData,\n  }\n  Object.entries(bugsnagMetadata).forEach(([section, values]) => {\n    event.addMetadata(section, values)\n  })\n}\n\nfunction initializeBugsnag() {\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  if (Bugsnag.isStarted()) {\n    return\n  }\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  Bugsnag.start({\n    appType: 'node',\n    apiKey: bugsnagApiKey,\n    logger: null,\n    appVersion: CLI_KIT_VERSION,\n    autoTrackSessions: false,\n    autoDetectErrors: false,\n    enabledReleaseStages: ['production'],\n    endpoints: {\n      notify: 'https://error-analytics-production.shopifysvc.com',\n      sessions: 'https://error-analytics-sessions-production.shopifysvc.com',\n    },\n    // Set the project root to `null` to prevent the default behavior of\n    // Bugsnag which is to set it to the cwd. That is unhelpful for us because\n    // the cwd can be anywhere in the user's filesystem, not necessarily\n    // related to the CLI codebase.\n    projectRoot: null,\n  })\n}\n"]}
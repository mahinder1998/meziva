{"version":3,"file":"graphql.js","sourceRoot":"","sources":["../../../../src/public/node/api/graphql.ts"],"names":[],"mappings":"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","sourcesContent":["import {buildHeaders, httpsAgent} from '../../../private/node/api/headers.js'\nimport {debugLogRequestInfo, errorHandler} from '../../../private/node/api/graphql.js'\nimport {addPublicMetadata, runWithTimer} from '../metadata.js'\nimport {retryAwareRequest} from '../../../private/node/api.js'\nimport {requestIdsCollection} from '../../../private/node/request-ids.js'\nimport {nonRandomUUID} from '../crypto.js'\nimport {\n  cacheRetrieveOrRepopulate,\n  ConfSchema,\n  GraphQLRequestKey,\n  TimeInterval,\n  timeIntervalToMilliseconds,\n} from '../../../private/node/conf-store.js'\nimport {LocalStorage} from '../local-storage.js'\nimport {abortSignalFromRequestBehaviour, requestMode, RequestModeInput} from '../http.js'\nimport {CLI_KIT_VERSION} from '../../common/version.js'\nimport {\n  GraphQLClient,\n  rawRequest,\n  RequestDocument,\n  resolveRequestDocument,\n  Variables,\n  ClientError,\n} from 'graphql-request'\nimport {TypedDocumentNode} from '@graphql-typed-document-node/core'\n\n// to replace TVariable type when there graphql query has no variables\nexport type Exact<T extends {[key: string]: unknown}> = {[K in keyof T]: T[K]}\n\nexport interface GraphQLVariables {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [key: string]: any\n}\n\nexport type GraphQLResponse<T> = Awaited<ReturnType<typeof rawRequest<T>>>\n\nexport interface CacheOptions {\n  cacheTTL: TimeInterval\n  cacheExtraKey?: string\n  cacheStore?: LocalStorage<ConfSchema>\n}\n\ninterface RefreshedTokenOnAuthorizedResponse {\n  token?: string\n}\n\nexport type RefreshTokenOnAuthorizedResponse = Promise<RefreshedTokenOnAuthorizedResponse>\n\nexport interface UnauthorizedHandler {\n  type: 'token_refresh'\n  handler: () => RefreshTokenOnAuthorizedResponse\n}\n\ninterface GraphQLRequestBaseOptions<TResult> {\n  api: string\n  url: string\n  token?: string\n  addedHeaders?: {[header: string]: string}\n  responseOptions?: GraphQLResponseOptions<TResult>\n  cacheOptions?: CacheOptions\n  preferredBehaviour?: RequestModeInput\n}\n\ntype PerformGraphQLRequestOptions<TResult> = GraphQLRequestBaseOptions<TResult> & {\n  queryAsString: string\n  variables?: Variables\n  unauthorizedHandler?: UnauthorizedHandler\n}\n\nexport type GraphQLRequestOptions<T> = GraphQLRequestBaseOptions<T> & {\n  query: RequestDocument\n  variables?: Variables\n  unauthorizedHandler?: UnauthorizedHandler\n}\n\nexport type GraphQLRequestDocOptions<TResult, TVariables> = GraphQLRequestBaseOptions<TResult> & {\n  query: TypedDocumentNode<TResult, TVariables> | TypedDocumentNode<TResult, Exact<{[key: string]: never}>>\n  variables?: TVariables\n  unauthorizedHandler?: UnauthorizedHandler\n}\n\nexport interface GraphQLResponseOptions<T> {\n  handleErrors?: boolean\n  onResponse?: (response: GraphQLResponse<T>) => void\n}\n\nasync function createGraphQLClient({\n  url,\n  addedHeaders,\n  token,\n}: {\n  url: string\n  token: string | undefined\n  addedHeaders?: {[header: string]: string}\n}) {\n  const headers = {\n    ...addedHeaders,\n    ...buildHeaders(token),\n  }\n  const clientOptions = {agent: await httpsAgent(), headers}\n\n  return {\n    client: new GraphQLClient(url, clientOptions),\n    headers,\n  }\n}\n\n/**\n * Handles execution of a GraphQL query.\n *\n * @param options - GraphQL request options.\n */\nasync function performGraphQLRequest<TResult>(options: PerformGraphQLRequestOptions<TResult>) {\n  const {token, addedHeaders, queryAsString, variables, api, url, responseOptions, unauthorizedHandler, cacheOptions} =\n    options\n  const behaviour = requestMode(options.preferredBehaviour ?? 'default')\n\n  let {headers, client} = await createGraphQLClient({url, addedHeaders, token})\n  debugLogRequestInfo(api, queryAsString, url, variables, headers)\n\n  const rawGraphQLRequest = async () => {\n    let fullResponse: GraphQLResponse<TResult>\n    // there is a errorPolicy option which returns rather than throwing on errors, but we _do_ ultimately want to\n    // throw.\n    try {\n      // mapping signal to any due to polyfill meaning types don't exactly match (but are functionally equivalent)\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      client.requestConfig.signal = abortSignalFromRequestBehaviour(behaviour) as any\n      fullResponse = await client.rawRequest<TResult>(queryAsString, variables)\n      await logLastRequestIdFromResponse(fullResponse)\n      return fullResponse\n    } catch (error) {\n      if (error instanceof ClientError) {\n        // error.response does have a headers property like a normal response, but it's not typed as such.\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        await logLastRequestIdFromResponse(error.response as any)\n      }\n      throw error\n    }\n  }\n\n  const tokenRefreshHandler = unauthorizedHandler?.handler\n\n  const tokenRefreshUnauthorizedHandlerFunction = tokenRefreshHandler\n    ? async () => {\n        const refreshTokenResult = await tokenRefreshHandler()\n        if (refreshTokenResult.token) {\n          const {client: newClient, headers: newHeaders} = await createGraphQLClient({\n            url,\n            addedHeaders,\n            token: refreshTokenResult.token,\n          })\n          client = newClient\n          headers = newHeaders\n          return true\n        } else {\n          return false\n        }\n      }\n    : undefined\n\n  const request = () =>\n    retryAwareRequest(\n      {request: rawGraphQLRequest, url, ...behaviour},\n      responseOptions?.handleErrors === false ? undefined : errorHandler(api),\n    )\n\n  const executeWithTimer = () =>\n    runWithTimer('cmd_all_timing_network_ms')(async () => {\n      let response\n      try {\n        response = await request()\n      } catch (error) {\n        if (error instanceof ClientError && error.response.status === 401 && tokenRefreshUnauthorizedHandlerFunction) {\n          if (await tokenRefreshUnauthorizedHandlerFunction()) {\n            response = await request()\n          } else {\n            throw error\n          }\n        } else {\n          throw error\n        }\n      }\n\n      if (responseOptions?.onResponse) {\n        responseOptions.onResponse(response)\n      }\n      return response.data\n    })\n\n  // If there is no cache config for this query, just execute it and return the result.\n  if (cacheOptions === undefined) {\n    return executeWithTimer()\n  }\n\n  const {cacheTTL, cacheExtraKey, cacheStore} = cacheOptions\n\n  // The cache key is a combination of the hashed query and variables, with an optional extra key provided by the user.\n  const queryHash = nonRandomUUID(queryAsString)\n  const variablesHash = nonRandomUUID(JSON.stringify(variables ?? {}))\n  const cacheKey: GraphQLRequestKey = `q-${queryHash}-${variablesHash}-${CLI_KIT_VERSION}-${cacheExtraKey ?? ''}`\n\n  const result = await cacheRetrieveOrRepopulate(\n    cacheKey,\n    async () => {\n      const result = await executeWithTimer()\n      return JSON.stringify(result)\n    },\n    timeIntervalToMilliseconds(cacheTTL),\n    cacheStore,\n  )\n\n  return JSON.parse(result) as TResult\n}\n\nasync function logLastRequestIdFromResponse(response: GraphQLResponse<unknown>) {\n  try {\n    const requestId = response.headers.get('x-request-id')\n    requestIdsCollection.addRequestId(requestId)\n    await addPublicMetadata(() => ({\n      cmd_all_last_graphql_request_id: requestId ?? undefined,\n    }))\n    // eslint-disable-next-line no-catch-all/no-catch-all\n  } catch {\n    // no problem if unable to get request ID.\n  }\n}\n\n/**\n * Executes a GraphQL query to an endpoint.\n *\n * @param options - GraphQL request options.\n * @returns The response of the query of generic type <T>.\n */\nexport async function graphqlRequest<T>(options: GraphQLRequestOptions<T>): Promise<T> {\n  return performGraphQLRequest<T>({\n    ...options,\n    queryAsString: options.query as string,\n  })\n}\n\n/**\n * Executes a GraphQL query to an endpoint. Uses typed documents.\n *\n * @param options - GraphQL request options.\n * @returns The response of the query of generic type <TResult>.\n */\nexport async function graphqlRequestDoc<TResult, TVariables extends Variables>(\n  options: GraphQLRequestDocOptions<TResult, TVariables>,\n): Promise<TResult> {\n  return performGraphQLRequest<TResult>({\n    ...options,\n    queryAsString: resolveRequestDocument(options.query).query,\n  })\n}\n"]}
{"version":3,"file":"schema.js","sourceRoot":"","sources":["../../../../src/private/node/session/schema.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,GAAG,EAAC,MAAM,gCAAgC,CAAA;AAElD,MAAM,UAAU,GAAG,GAAG,CAAC,UAAU,CAAC,CAAC,GAAG,EAAE,EAAE;IACxC,IAAI,OAAO,GAAG,KAAK,QAAQ,IAAI,GAAG,YAAY,IAAI;QAAE,OAAO,IAAI,IAAI,CAAC,GAAG,CAAC,CAAA;IACxE,OAAO,IAAI,CAAA;AACb,CAAC,EAAE,GAAG,CAAC,IAAI,EAAE,CAAC,CAAA;AAEd;;GAEG;AACH,MAAM,mBAAmB,GAAG,GAAG,CAAC,MAAM,CAAC;IACrC,WAAW,EAAE,GAAG,CAAC,MAAM,EAAE;IACzB,YAAY,EAAE,GAAG,CAAC,MAAM,EAAE;IAC1B,SAAS,EAAE,UAAU;IACrB,MAAM,EAAE,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC;IAC/B,MAAM,EAAE,GAAG,CAAC,MAAM,EAAE;IACpB,KAAK,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;CAC/B,CAAC,CAAA;AAEF;;GAEG;AACH,MAAM,sBAAsB,GAAG,GAAG,CAAC,MAAM,CAAC;IACxC,WAAW,EAAE,GAAG,CAAC,MAAM,EAAE;IACzB,SAAS,EAAE,UAAU;IACrB,MAAM,EAAE,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC;IAC/B,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;CACnC,CAAC,CAAA;AAEF,MAAM,aAAa,GAAG,GAAG,CAAC,MAAM,CAAC;IAC/B,QAAQ,EAAE,mBAAmB;IAC7B,YAAY,EAAE,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,sBAAsB,CAAC;CAC9D,CAAC,CAAA;AAEF;;;;;;;;;;;;;;;;;;;;;;;;;;;GA2BG;AACH,MAAM,CAAC,MAAM,cAAc,GAAG,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAC,CAAA;AAO7F;;;;GAIG;AACH,MAAM,UAAU,oCAAoC,CAAC,aAAsB;IACzE,MAAM,MAAM,GAAG,mBAAmB,CAAC,SAAS,CAAC,aAAa,CAAC,CAAA;IAC3D,OAAO,MAAM,CAAC,OAAO,CAAA;AACvB,CAAC","sourcesContent":["import {zod} from '../../../public/node/schema.js'\n\nconst DateSchema = zod.preprocess((arg) => {\n  if (typeof arg === 'string' || arg instanceof Date) return new Date(arg)\n  return null\n}, zod.date())\n\n/**\n * The schema represents an Identity token.\n */\nconst IdentityTokenSchema = zod.object({\n  accessToken: zod.string(),\n  refreshToken: zod.string(),\n  expiresAt: DateSchema,\n  scopes: zod.array(zod.string()),\n  userId: zod.string(),\n  alias: zod.string().optional(),\n})\n\n/**\n * The schema represents an application token.\n */\nconst ApplicationTokenSchema = zod.object({\n  accessToken: zod.string(),\n  expiresAt: DateSchema,\n  scopes: zod.array(zod.string()),\n  storeFqdn: zod.string().optional(),\n})\n\nconst SessionSchema = zod.object({\n  identity: IdentityTokenSchema,\n  applications: zod.object({}).catchall(ApplicationTokenSchema),\n})\n\n/**\n * This schema represents the format of the session\n * that we cache in the system to avoid unnecessary\n * token exchanges.\n *\n * @example\n * ```\n * {\n *   \"accounts.shopify.com\": {\n *     \"user-123\": {\n *       \"identity\": { ... }, // IdentityTokenSchema\n *       \"applications\": {\n *         \"mystore.myshopify.com-admin\": { // ApplicationTokenSchema\n *           \"accessToken\": \"...\",\n *           \"expiresAt\": \"...\",\n *           \"scopes\": [\"...\"],\n *         },\n *         \"partners\": { ... },\n *       }\n *     },\n *     \"8765-4321\": { ... }\n *   },\n *   \"identity.spin.com\": {\n *     \"user-345\": { ... }\n *   }\n * }\n * ```\n */\nexport const SessionsSchema = zod.object({}).catchall(zod.object({}).catchall(SessionSchema))\n\nexport type Sessions = zod.infer<typeof SessionsSchema>\nexport type Session = zod.infer<typeof SessionSchema>\nexport type IdentityToken = zod.infer<typeof IdentityTokenSchema>\nexport type ApplicationToken = zod.infer<typeof ApplicationTokenSchema>\n\n/**\n * Confirms that a given identity token structure matches what the schema currently defines.\n *\n * A full re-auth is the expectation if this validation fails.\n */\nexport function validateCachedIdentityTokenStructure(identityToken: unknown) {\n  const parsed = IdentityTokenSchema.safeParse(identityToken)\n  return parsed.success\n}\n"]}
{"version":3,"file":"webhooks.js","sourceRoot":"","sources":["../../../../src/public/node/api/webhooks.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,iBAAiB,EAAsB,MAAM,cAAc,CAAA;AACnE,OAAO,EAAC,iBAAiB,EAAC,MAAM,oBAAoB,CAAA;AACpD,OAAO,UAAU,MAAM,YAAY,CAAA;AAInC,mBAAmB;AACnB,gCAAgC;AAChC,iDAAiD;AACjD,MAAM,OAAO,GAAG,IAAI,UAAU,CAAC;IAC7B,OAAO,EAAE,GAAG;IACZ,aAAa,EAAE,EAAE;CAClB,CAAC,CAAA;AAaF;;;;;;GAMG;AACH,MAAM,CAAC,KAAK,UAAU,kBAAkB,CACtC,OAAoD;IAEpD,MAAM,GAAG,GAAG,UAAU,CAAA;IACtB,MAAM,IAAI,GAAG,MAAM,iBAAiB,EAAE,CAAA;IACtC,MAAM,GAAG,GAAG,WAAW,IAAI,oCAAoC,OAAO,CAAC,cAAc,eAAe,CAAA;IACpG,MAAM,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAU,GAAG,EAAE,CAC5C,iBAAiB,CAAsB;QACrC,KAAK,EAAE,OAAO,CAAC,KAAK;QACpB,GAAG;QACH,GAAG;QACH,KAAK,EAAE,OAAO,CAAC,KAAK;QACpB,SAAS,EAAE,OAAO,CAAC,SAAS;QAC5B,mBAAmB,EAAE,OAAO,CAAC,mBAAmB;KACjD,CAAC,CACH,CAAA;IAED,OAAO,MAAM,CAAA;AACf,CAAC","sourcesContent":["import {graphqlRequestDoc, UnauthorizedHandler} from './graphql.js'\nimport {appManagementFqdn} from '../context/fqdn.js'\nimport Bottleneck from 'bottleneck'\nimport {Variables} from 'graphql-request'\nimport {TypedDocumentNode} from '@graphql-typed-document-node/core'\n\n// API Rate limiter\n// Jobs are launched every 150ms\n// Only 10 requests can be executed concurrently.\nconst limiter = new Bottleneck({\n  minTime: 150,\n  maxConcurrent: 10,\n})\n\n/**\n * Options for making requests to the Webhooks API.\n */\nexport interface WebhooksRequestOptions<TResult, TVariables extends Variables> {\n  organizationId: string\n  query: TypedDocumentNode<TResult, TVariables>\n  token: string\n  unauthorizedHandler: UnauthorizedHandler\n  variables?: TVariables\n}\n\n/**\n * Executes an org-scoped GraphQL query against the App Management API.\n * Uses typed documents.\n *\n * @param options - The options for the request.\n * @returns The response of the query of generic type <T>.\n */\nexport async function webhooksRequestDoc<TResult, TVariables extends Variables>(\n  options: WebhooksRequestOptions<TResult, TVariables>,\n): Promise<TResult> {\n  const api = 'Webhooks'\n  const fqdn = await appManagementFqdn()\n  const url = `https://${fqdn}/webhooks/unstable/organizations/${options.organizationId}/graphql.json`\n  const result = limiter.schedule<TResult>(() =>\n    graphqlRequestDoc<TResult, TVariables>({\n      query: options.query,\n      api,\n      url,\n      token: options.token,\n      variables: options.variables,\n      unauthorizedHandler: options.unauthorizedHandler,\n    }),\n  )\n\n  return result\n}\n"]}
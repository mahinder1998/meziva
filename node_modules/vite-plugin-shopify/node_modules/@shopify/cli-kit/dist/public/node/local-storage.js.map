{"version":3,"file":"local-storage.js","sourceRoot":"","sources":["../../../src/public/node/local-storage.ts"],"names":[],"mappings":"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","sourcesContent":["import {AbortError, BugError} from './error.js'\nimport {fileHasWritePermissions, unixFileIsOwnedByCurrentUser} from './fs.js'\nimport {dirname} from './path.js'\nimport {TokenItem} from './ui.js'\nimport Config from 'conf'\n\n/**\n * A wrapper around the `conf` package that provides a strongly-typed interface\n * for accessing the local storage.\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport class LocalStorage<T extends {[key: string]: any}> {\n  private readonly config: Config<T>\n\n  constructor(options: {projectName?: string; cwd?: string}) {\n    this.config = new Config<T>(options)\n  }\n\n  /**\n   * Get a value from the local storage.\n   *\n   * @param key - The key to get.\n   * @returns The value.\n   * @throws AbortError if a permission error occurs.\n   * @throws BugError if an unexpected error occurs.\n   */\n  get<TKey extends keyof T>(key: TKey): T[TKey] | undefined {\n    try {\n      return this.config.get(key)\n      // eslint-disable-next-line no-catch-all/no-catch-all\n    } catch (error) {\n      this.handleError(error, 'get')\n    }\n  }\n\n  /**\n   * Set a value in the local storage.\n   *\n   * @param key - The key to set.\n   * @param value - The value to set.\n   * @throws AbortError if a permission error occurs.\n   * @throws BugError if an unexpected error occurs.\n   */\n  set<TKey extends keyof T>(key: TKey, value?: T[TKey]): void {\n    try {\n      this.config.set(key, value)\n      // eslint-disable-next-line no-catch-all/no-catch-all\n    } catch (error) {\n      this.handleError(error, 'set')\n    }\n  }\n\n  /**\n   * Delete a value from the local storage.\n   *\n   * @param key - The key to delete.\n   * @throws AbortError if a permission error occurs.\n   * @throws BugError if an unexpected error occurs.\n   */\n  delete<TKey extends keyof T>(key: TKey): void {\n    try {\n      this.config.delete(key)\n      // eslint-disable-next-line no-catch-all/no-catch-all\n    } catch (error) {\n      this.handleError(error, 'delete')\n    }\n  }\n\n  /**\n   * Clear the local storage (delete all values).\n   *\n   * @throws AbortError if a permission error occurs.\n   * @throws BugError if an unexpected error occurs.\n   */\n  clear(): void {\n    try {\n      this.config.clear()\n      // eslint-disable-next-line no-catch-all/no-catch-all\n    } catch (error) {\n      this.handleError(error, 'clear')\n    }\n  }\n\n  /**\n   * Handle errors from config operations.\n   * If the error is permission-related, throw an AbortError with helpful hints.\n   * Otherwise, throw a BugError.\n   *\n   * @param error - The error that occurred.\n   * @param operation - The operation that failed.\n   * @throws AbortError if the error is permission-related.\n   * @throws BugError if the error is not permission-related.\n   */\n  private handleError(error: unknown, operation: string): never {\n    if (this.isPermissionError()) {\n      throw new AbortError(`Failed to access local storage (${operation}): ${error}`, this.tryMessage())\n    } else {\n      throw new BugError(\n        `Unexpected error while accessing local storage at ${this.config.path} (${operation}): ${error}`,\n      )\n    }\n  }\n\n  private isPermissionError(): boolean {\n    const canAccessFile = fileHasWritePermissions(this.config.path)\n    const canAccessFolder = fileHasWritePermissions(dirname(this.config.path))\n    const ownsFile = unixFileIsOwnedByCurrentUser(this.config.path)\n\n    return !canAccessFile || !canAccessFolder || ownsFile === false\n  }\n\n  private tryMessage() {\n    const ownsFile = unixFileIsOwnedByCurrentUser(this.config.path)\n    const ownsFolder = unixFileIsOwnedByCurrentUser(dirname(this.config.path))\n\n    const message: TokenItem = [`Check that you have write permissions for`, {filePath: this.config.path}]\n    if (ownsFile === false || ownsFolder === false) {\n      message.push(\n        '- The file is owned by a different user. This typically happens when Shopify CLI was previously run with elevated permissions (e.g., sudo).',\n      )\n    }\n\n    message.push('\\n\\nTo resolve this, remove the Shopify CLI preferences folder:')\n    message.push({command: `rm -rf ${dirname(this.config.path)}`})\n\n    return message\n  }\n}\n"]}